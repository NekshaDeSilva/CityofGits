    <!-- Landscape Orientation Overlay -->
    <div id="landscape-overlay" style="display:none;">
        <div class="landscape-overlay-content">
            <img src="assets/static/cityofgits-white-lg-4000x1010.png" alt="CityofGits Logo" class="landscape-logo" />
            <span class="landscape-icon"><i class="bi bi-phone"></i></span>
            <div class="landscape-message">Please flip your device to explore</div>
        </div>
    </div>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>CityofGits | Play</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="./styles/styles.css">
    <link rel="stylesheet" href="./styles/landscape-overlay.css">
</head>
<body>
    <!-- Fixed Top-Right Animated Button -->
    <div id="promo-sticker" title="Free stickers!" onclick="window.open('https://about.cityofgits.link/free-stickers', '_blank');">
        <span id="promo-sticker-glow">
            <img src="assets/static/glow.png" alt="Glow" />
        </span>
        <img src="assets/static/cityofgits_stickets-summer-long.png" alt="Promo Sticker">
    </div>

<!-- Floating Badge Logo for OpenRockets -->

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- Left UI Column Container - Modern Style -->
        <div id="left-ui-column">
            <!-- Logo without wrapper -->
            <img id="dynamic-logo" src="./assets/static/cityofgits-summercap-dark-lg-4000x1010.png" alt="CityofGits Logo" />
            
            <!-- Status Panel - Modern Style -->
            <div id="gaming-ui-bar" class="modern-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="bi bi-graph-up"></i>
                        WORLD
                    </h3>
                </div>
                
                <div class="ui-section" id="player-stats">
                    <div class="stat-item">
                        <div class="stat-icon-wrapper">
                            <i class="bi bi-controller"></i>
                        </div>
                        <div class="stat-content">

                            <span class="stat-value" id="movement-mode">FLY</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon-wrapper">
                            <i class="bi bi-rulers"></i>
                        </div>
                        <div class="stat-content">

                            <span class="stat-value" id="height-display">1187m</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon-wrapper">
                            <i class="bi bi-speedometer2"></i>
                        </div>
                        <div class="stat-content">

                            <span class="stat-value" id="speed-display">3x</span>
                        </div>
                    </div>
                </div>
                
                <div class="divider"></div>
                
           
            </div>
            
            <!-- Control Panel -->
            <div id="navigation-display" class="modern-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="bi bi-sunglasses"></i>
                        Controls
                    </h3>
                </div>
                
                <div class="controls-grid">
                    <div class="wasd-grid">
                        <button class="control-btn control-btn-primary nav-key nav-key-w" id="nav-w">
                       <i class="bi bi-caret-up-fill"></i>
                        </button>
                        <button class="control-btn control-btn-primary nav-key nav-key-a" id="nav-a">
                        <i class="bi bi-caret-left-fill"></i>
                        </button>
                        <button class="control-btn control-btn-primary nav-key nav-key-s" id="nav-s">
                        <i class="bi bi-caret-down-fill"></i>
                        </button>
                        <button class="control-btn control-btn-primary nav-key nav-key-d" id="nav-d">
                            <i class="bi bi-caret-right-fill"></i>
                        
                        </button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="control-btn control-btn-secondary nav-key nav-key-shift" id="nav-shift">
                            <i class="bi bi-shift"></i>
                            <span class="key-label">SHIFT</span>
                            <span class="key-hint">Run</span>
                        </button>
                        <button class="control-btn control-btn-secondary nav-key nav-key-space" id="nav-space">
                            <i class="bi bi-arrow-up-circle"></i>
                            <span class="key-label">SPACE</span>
                            <span class="key-hint">Jump</span>
                        </button>
                        <button class="control-btn control-btn-secondary nav-key nav-key-f" id="nav-f">
                            <i class="bi bi-airplane"></i>
                            <span class="key-label">F</span>
                            <span class="key-hint">Fly</span>
                        </button>
                    </div>
                </div>
        
        </div>
            <div class="contribute-token-click" onclick="window.open('https://github.com/openrockets/cityofgits', '_blank');">
                <i class="bi bi-github" style="font-size:2rem; margin-right: .5rem;"></i>
                <a id="openrockets-badge" href="https://openrockets.me/about" target="_blank" title="About OpenRockets">
  <img src="assets/static/openrockets-logo.png" alt="OpenRockets Badge" />
</a>
                <span style="font-size: 1rem; margin-left: 1.5rem;">Contribute</span>
            </div>
        </div>
        <!-- Mobile Game Navigator -->
       
    </div>

    <!-- Building Information Popup -->
  
    <div id="building-info-popup">
        <div class="popup-header">
            <button class="popup-close" id="popup-close" title="Close building information" aria-label="Close popup">
                <i class="bi bi-x"></i>
            </button>
            <div class="building-title-container">
                <h2 class="building-title" id="building-title">Building Name</h2>
                <div class="verified-badge-container" id="verified-badge-container" style="display: none;">
                    <img src="./assets/static/verified_badge.png" alt="Verified" class="verified-badge" id="verified-badge" />
                    <div class="tax-tooltip" id="tax-tooltip">Tax ID: Loading...</div>
                </div>
            </div>
            <p class="building-subtitle" id="building-subtitle">Building Type</p>
        </div>
        <div class="popup-content">
            <div class="info-section">
                <h4><i class="bi bi-person-circle"></i> Owner Information</h4>
                <div class="bio-text" id="building-bio">
                    Bio information will appear here...
                </div>
            </div>
            
            <div class="building-stats" id="building-stats">
                <div class="stat-card">
                    <span class="stat-value" id="building-height">--</span>

                </div>
                <div class="stat-card">
                    <span class="stat-value" id="building-floors">--</span>
    
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="building-year">--</span>

                </div>
            </div>

            <div class="building-description">
                <h5>About This Building</h5>
                <p id="building-description">Building description will appear here...</p>
            </div>

            <div class="info-section">
                <h4><i class="bi bi-link-45deg"></i> Connect & Follow</h4>
                <div class="social-links" id="social-links">
                    <!-- Social links will be dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js from CDN -->
    <script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
    
    <!-- Our application scripts - OPTIMIZED for 4GB RAM -->
    <script src="./app/building-popup.js"></script>
    <script src="./app/world_optimized.js"></script>
    <script src="./app/gaming-ui.js"></script>
    <script src="./app/app.js"></script>
    <script src="./app/index.js"></script>
    <script src="app/promo-sticker-glow.js"></script>
    <script src="app/landscape-overlay.js"></script>
    <script>
      // Delay left-ui-column animation by 2 seconds after DOMContentLoaded
      document.addEventListener('DOMContentLoaded', function() {
        var leftUi = document.getElementById('left-ui-column');
        if (leftUi) {
          // Remove animation, then re-add after 2s to trigger
          leftUi.style.animation = 'none';
          leftUi.offsetHeight; // force reflow
          setTimeout(function() {
            leftUi.style.animation = 'leftUiSlideIn 0.7s cubic-bezier(.4,1.4,.6,1) forwards';
          }, 2000);
        }
      });
    </script>
    <!-- Halloween Chat Input UI -->
     <div id="chatbox"></div>
    <div id="halloween-chat-container">

      <input id="halloween-chat-input" type="text" placeholder="MESSAGES" maxlength="200" autocomplete="off" />
      <span id="halloween-chat-icon">
        
<i class="bi bi-box"></i>
      </span>
    </div>
    <div id="halloween-chat-popup" tabindex="-1">
      <div id="halloween-chat-popup-inner">
        <span id="halloween-chat-popup-close">Ã—</span>
        <input id="halloween-chat-popup-input" type="text" placeholder="send message" maxlength="200" autocomplete="off" />
      </div>
    </div>
    <script>
    // Halloween Chat UI logic
    (function() {
      const chatContainer = document.getElementById('halloween-chat-container');
      const chatInput = document.getElementById('halloween-chat-input');
      const chatIcon = document.getElementById('halloween-chat-icon');
      const chatPopup = document.getElementById('halloween-chat-popup');
      const chatPopupInput = document.getElementById('halloween-chat-popup-input');
      const chatPopupClose = document.getElementById('halloween-chat-popup-close');

      // Open popup on C key
      document.addEventListener('keydown', function(e) {
        if ((e.key === 'c' || e.key === 'C') && !chatPopup.classList.contains('open')) {
          chatPopup.classList.add('open');
          setTimeout(()=>chatPopupInput.focus(), 350);
        }
      });

      // Close popup on close button
      chatPopupClose.addEventListener('click', function() {
        chatPopup.classList.remove('open');
      });

      // Handle Enter and Esc in popup input
      chatPopupInput.addEventListener('keydown', function(e) {
        const msg = chatPopupInput.value.trim();
        if (e.key === 'Enter' && msg.length > 0) {
          afterChatPlay(msg);
          chatPopupInput.value = '';
          chatPopup.classList.remove('open');
        } else if (e.key === 'Escape' && msg.length === 0) {
          chatPopup.classList.remove('open');
        }
      });

      // Also open popup if user clicks the small chat input
      chatInput.addEventListener('focus', function() {
        chatPopup.classList.add('open');
        setTimeout(()=>chatPopupInput.focus(), 350);
      });

      // Prevent form submit on Enter in small input
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          chatPopup.classList.add('open');
          setTimeout(()=>chatPopupInput.focus(), 350);
        }
      });

      // Optional: close popup on outside click
      chatPopup.addEventListener('mousedown', function(e) {
        if (e.target === chatPopup) chatPopup.classList.remove('open');
      });
    })();

    // Function to be called after chat message is sent
    function afterChatPlay(message) {
      // To be implemented
    }


    let latestMessages = []; // Holds latest 5 messages

// Send chat message to backend for storage
async function afterChatPlay(message) {
  if (!message || !message.trim()) return; // Ignore empty messages

  try {
    await fetch('/api/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: message.trim() }),
    });
  } catch (error) {
    console.error('Failed to send message:', error);
  }
}

// Render chatbox with messages and an input form
function renderChatBox() {
  let chatbox = document.getElementById('chatbox');
  if (!chatbox) {
    chatbox = document.createElement('div');
    chatbox.id = 'chatbox';
    chatbox.style.border = '1px solid #ccc';
    chatbox.style.height = '300px';
    chatbox.style.overflowY = 'auto';
    chatbox.style.backgroundColor = '#fff';
    chatbox.style.padding = '10px';
    chatbox.style.fontFamily = 'sans-serif';
    document.body.appendChild(chatbox);

    // Add input area for sending messages
    const inputContainer = document.createElement('div');
    inputContainer.style.marginTop = '10px';

    const input = document.createElement('input');
    input.type = 'text';
    input.id = 'chatInput';
    input.placeholder = 'Type your message here...';
    input.style.width = '80%';
    input.style.padding = '8px';

    const sendBtn = document.createElement('button');
    sendBtn.textContent = 'Send';
    sendBtn.style.padding = '8px 12px';
    sendBtn.style.marginLeft = '5px';

    sendBtn.onclick = async () => {
      const msg = input.value;
      if (msg.trim()) {
        await afterChatPlay(msg);
        input.value = '';
        await pollMessages(); // Refresh messages after sending
      }
    };

    input.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        sendBtn.click();
      }
    });

    inputContainer.appendChild(input);
    inputContainer.appendChild(sendBtn);
    document.body.appendChild(inputContainer);
  }

  // Clear existing messages
  chatbox.innerHTML = '';

  // Append latest messages
  latestMessages.forEach(msg => {
    const div = document.createElement('div');
    div.textContent = msg.message;
    chatbox.appendChild(div);
  });

  chatbox.scrollTop = chatbox.scrollHeight;
}

// Poll latest 5 messages every 3 seconds
async function pollMessages() {
  try {
    const res = await fetch('/api/latest');
    if (!res.ok) throw new Error('Network response was not ok');

    const data = await res.json();

    // Always update without comparing
    latestMessages = data;
    renderChatBox();
  } catch (e) {
    console.error('Error fetching messages:', e);
  }
}


setInterval(pollMessages, 3000);
pollMessages(); // initial fetch

    </script>
    </body>
</html>
